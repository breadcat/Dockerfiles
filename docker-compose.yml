
# docker network create caddy

version: '2'

networks:
  caddy:
    external: true

services:
  watchtower:
    image: v2tec/watchtower
    container_name: watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --schedule "0 0 4 * * *" --cleanup
  sslh:
    image: shaddysignal/sslh-hub
    container_name: sslh
    restart: always
    ports:
      - 443:443
    environment:
      - SSH_HOST=$IPLOC
      - HTTPS_HOST=$IPLOC
  caddy:
    image: lucaslorentz/caddy-docker-proxy
    container_name: caddy
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - $CONFDIR/caddy:/root/.caddy
    ports:
      - 80:80
      - 8443:443
    networks:
      - caddy
  syncthing:
    image: linuxserver/syncthing
    container_name: syncthing
    restart: always
    volumes:
      - $CONFDIR/syncthing:/config
      - $SYNCDIR:/vault
      - $SAVEDIR:/saves
    ports:
      - 22000:22000
      - 21027:21027/udp
    environment:
      - PGID=$PGID
      - PUID=$PUID
    networks:
      - caddy
    labels:
      caddy.address: sync.$DOMAIN
      caddy.targetport: "8384"
  transmission:
    image: linuxserver/transmission
    container_name: transmission
    restart: always
    volumes:
      - $CONFDIR/transmission:/config
      - $DOWNDIR:/downloads
      - $SYNCDIR/watch:/watch
    ports:
      - 9091:9091
      - 51413:51413
      - 51413:51413/udp
    environment:
      - PGID=$PGID
      - PUID=$PUID
      - TZ=$TZ
    networks:
      - caddy
    labels:
      caddy.address: tor.$DOMAIN
      caddy.targetport: "9091"
  selfoss:
    image: arckosfr/selfoss
    container_name: selfoss
    restart: always
    volumes:
      - $CONFDIR/selfoss:/selfoss/data
    environment:
      - CRON_PERIOD=60m
    networks:
      - caddy
    labels:
      caddy.address: rss.$DOMAIN
      caddy.targetport: "8080"
      caddy.basicauth: / $NAME $PASS
  baikal:
    image: ckulka/baikal
    container_name: baikal
    restart: always
    volumes:
      - $CONFDIR/baikal:/var/www/baikal/Specific
    networks:
      - caddy
    labels:
      caddy.address: dav.$DOMAIN
      caddy.targetport: "80"
  keeweb:
    image: viossat/keeweb-webdav
    container_name: keeweb
    restart: always
    volumes:
      - $CONFDIR/keeweb:/var/www/html/webdav
    environment:
      - WEBDAV_USERNAME=$NAME
      - WEBDAV_PASSWORD=$PASS
    networks:
      - caddy
    labels:
      caddy.address: pass.$DOMAIN
      caddy.targetport: "80"
  mumble:
    image: coppit/mumble-server
    container_name: mumble
    restart: always
    ports:
      - 64738:64738
      - 64738:64738/udp
    volumes:
      - $CONFDIR/mumble:/data
  dir-pub:
    image: corfr/h5ai
    container_name: dir-pub
    restart: always
    volumes:
      - $SYNCDIR/pub:/var/www
    networks:
      - caddy
    labels:
      caddy.address: pub.$DOMAIN
      caddy.targetport: "80"
  dir-repo:
    image: corfr/h5ai
    container_name: dir-repo
    restart: always
    command: bash -c "sed -i 's|\"^_h5ai\"|\"^_h5ai\", \"lost\\\\\\\+found\"|' /usr/share/h5ai/_h5ai/private/conf/options.json && supervisord -c /etc/supervisor/conf.d/supervisord.conf"
    volumes:
      -  $POOLDIR:/var/www
    networks:
      - caddy
    labels:
      caddy.address: repo.$DOMAIN
      caddy.targetport: "80"
      caddy.basicauth_1: / $NAME $PASS
      caddy.basicauth_2: / $ALTU $ALTP
  cgit:
    image: invokr/cgit
    container_name: cgit
    restart: always
    volumes:
      - $SYNCDIR/src:/git
    networks:
      - caddy
    labels:
      caddy.address: git.$DOMAIN
      caddy.targetport: "80"
  ipd:
    image: joshdvir/ipd
    container_name: ipd
    restart: always
    command: bash -c "sed -i 's/feep.me/$DOMAIN/g' index.html && ipd --country-db GeoLite2-Country.mmdb --port-lookup --reverse-lookup --trusted-header X-Forwarded-For --template /root/index.html"
    networks:
      - caddy
    labels:
      caddy.address: ip.$DOMAIN
      caddy.targetport: "8080"
  php-dev:
    image: php:apache
    container_name: php-dev
    command: bash -c "a2enmod rewrite && apache2-foreground"
    restart: always
    volumes:
      - $SYNCDIR/src/dev:/var/www/html
      - $SYNCDIR/pub/.fjournal/:/fj
      - $SYNCDIR/pub/.weight/:/weight
    networks:
      - caddy
    labels:
      caddy.address: dev.$DOMAIN
      caddy.targetport: "80"
  beets: # docker exec -it beets /bin/bash
    image: linuxserver/beets
    container_name: beets
    volumes:
      - $CONFDIR/beets:/config
      - $DOWNDIR/complete:/downloads
      - $POOLDIR/audio:/music
    environment:
      - PGID=$PGID
      - PUID=$PUID
  cbreader:
    build: cbreader
    container_name: cbreader
    restart: always
    volumes:
      - $POOLDIR/literature/comics:/comics
    networks:
      - caddy
    labels:
      caddy.address: cbr.$DOMAIN
      caddy.targetport: "80"
      caddy.basicauth_1: / $NAME $PASS
      caddy.basicauth_2: / $ALTU $ALTP
  pico-cms:
    build: pico-cms
    container_name: pico-cms
    restart: always
    volumes:
      - $SYNCDIR/docs/blog:/var/www/html/content
      - $CONFDIR/pico:/var/www/html/config
    networks:
      - caddy
    labels:
      caddy.address: blog.$DOMAIN www.$DOMAIN $DOMAIN
      caddy.targetport: "80"
  the-epube: # docker exec -it the-epube php "/var/www/html/useradm.php" --add $(whoami)
    build: the-epube
    container_name: the-epube
    restart: always
    volumes:
      - $POOLDIR/literature/books:/home/fox/Books
    networks:
      - caddy
    labels:
      caddy.address: lib.$DOMAIN
      caddy.targetport: "80"
  kms-server:
    build: kms-server
    container_name: kms-server
    restart: always
    ports:
      - 1688:1688
  flexget:
    image: activ/arch-flexget
    container_name: flexget
    restart: always
    volumes:
      - $CONFDIR/flexget:/config
      - $DOWNDIR/complete:/input
      - $POOLDIR:/output
    environment:
      - PGID=$PGID
      - PUID=$PUID
  pihole:
    image: pihole/pihole
    container_name: pihole
    restart: always
    volumes:
      - $CONFDIR/pihole/config:/etc/pihole
      - $CONFDIR/pihole/dnsmasq:/etc/dnsmasq.d
    environment:
      - ServerIP=$IPEXT
      - TZ=$TZ
      - WEBPASSWORD=$PASS
      - DNS1=1.1.1.1
      - DNS2=8.8.8.8
    ports:
      - 53:53
      - 53:53/udp
      - 67:67/udp
      - 9053:80
      - 9054:443
    networks:
      - caddy
    labels:
      caddy.address: dns.$DOMAIN
      caddy.targetport: "80"
